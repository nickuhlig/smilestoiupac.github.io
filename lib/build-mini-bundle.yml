name: Build IUPAC mini-bundle

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/build-mini-bundle.yml

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare folders
        run: |
          rm -rf bundle work lib
          mkdir -p bundle work lib

      - name: Download CDK & Ambit jars
        run: |
          cd work
          curl -L -o cdk-interfaces-2.9.jar https://repo1.maven.org/maven2/org/openscience/cdk/cdk-interfaces/2.9/cdk-interfaces-2.9.jar
          curl -L -o cdk-core-2.9.jar       https://repo1.maven.org/maven2/org/openscience/cdk/cdk-core/2.9/cdk-core-2.9.jar
          curl -L -o cdk-smiles-2.9.jar     https://repo1.maven.org/maven2/org/openscience/cdk/cdk-smiles/2.9/cdk-smiles-2.9.jar
          curl -L -o cdk-dict-2.9.jar       https://repo1.maven.org/maven2/org/openscience/cdk/cdk-dict/2.9/cdk-dict-2.9.jar
          # Ambit 3.0.0 (download from SourceForge mirror)
          curl -L -o ambit2-structure2name-3.0.0.jar \
            https://downloads.sourceforge.net/project/ambit/Ambit2/AMBIT_modules/3.0.0/ambit2-structure2name-3.0.0.jar

      - name: Unpack all jars into bundle/
        run: |
          cd work
          for J in *.jar; do
            echo "Unzipping $J"
            unzip -q "$J" -d ../bundle
          done

      - name: Build combined JAR
        run: |
          cd bundle
          # Remove signature files if present (avoid security metadata conflicts)
          find . -type f \( -name "*.SF" -o -name "*.DSA" -o -name "*.RSA" \) -delete
          zip -qr ../lib/iupac-mini-bundle.jar .

      - name: Show bundle size
        run: du -h lib/iupac-mini-bundle.jar

      - name: Commit mini-bundle into repo
        run: |
          if [ -n "$(git status --porcelain lib/iupac-mini-bundle.jar)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add lib/iupac-mini-bundle.jar
            git commit -m "Add/update iupac-mini-bundle.jar (CDK 2.9 + Ambit 3.0.0)"
            git push
          else
            echo "No changes to commit."
          fi
