<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SMILES → IUPAC (Ambit2 + CDK)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#0b1020; color:#e9eefc; }
    .wrap { max-width: 860px; margin: 40px auto; padding: 0 16px; }
    .card { background:#121831; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 12px; font-size:24px; }
    textarea { width:100%; min-height:120px; background:#0c1328; color:#e9eefc; border:1px solid #1e2a55; border-radius:10px; padding:12px; }
    .row { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; align-items:center; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #2a3a78; background:#1a2650; color:#e9eefc; cursor:pointer; }
    button.primary { background:linear-gradient(135deg,#427bff,#6aa3ff); border:none; }
    .status { margin-top:10px; font-size:13px; color:#9fb0d6; }
    .out { white-space:pre-wrap; background:#0c1328; border:1px solid #1e2a55; border-radius:10px; padding:12px; margin-top:12px; min-height:48px; }
    .badge { font-size:12px; color:#9fb0d6; margin-left:8px; }
    .err { color:#ff6a6a } .ok { color:#36cfc9 } .warn { color:#ffd166 }
  </style>
  <!-- CheerpJ v4 loader -->
  <script src="https://cjrtnc.leaningtech.com/4.2/loader.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>SMILES → IUPAC (Ambit2 + CDK, offline)</h1>
      <p style="margin:0 0 12px;color:#9fb0d6">
        Runs entirely in your browser via CheerpJ. All jars served from this repo’s <code>lib/</code>.
      </p>

      <label for="smiles" style="font-size:12px;color:#9fb0d6">Isomeric SMILES</label>
      <textarea id="smiles">CC(=O)OC1=CC=CC=C1C(=O)O</textarea>

      <div class="row">
        <button id="run" class="primary">Generate IUPAC</button>
        <button id="copy">Copy</button>
        <button id="clear">Clear</button>
        <span class="badge">Runtime: <span id="cjState">not loaded</span></span>
      </div>

      <div id="status" class="status">Waiting…</div>
      <div id="output" class="out"></div>
    </div>
  </div>

<script>
  function S(x){ try{
    if(x==null) return String(x);
    if(typeof x==='string') return x;
    if(x instanceof Error) return x.message||x.toString();
    const t=x.toString?.(); if(t && t!=='[object Object]') return t;
    return JSON.stringify(x);
  }catch{ return '<unprintable>'; } }

  const smilesEl=document.getElementById('smiles');
  const outEl=document.getElementById('output');
  const statusEl=document.getElementById('status');
  const cjState=document.getElementById('cjState');

  function setStatus(msg,cls){ statusEl.textContent=S(msg); statusEl.className='status'+(cls?' '+cls:''); }
  function log(msg,cls){ const d=document.createElement('div'); d.textContent=S(msg); if(cls) d.className=cls; outEl.appendChild(d); }

  let cj=null, inited=false;

  function libURL(f){
    const parts=window.location.pathname.split('/').filter(Boolean);
    const base=parts.length?('/'+parts[0]+'/'):'/';
    return new URL('lib/'+f, new URL(base, window.location.origin)).toString();
  }

  const JARS=[
    'cdk-interfaces-2.9.jar',
    'cdk-core-2.9.jar',
    'cdk-smiles-2.9.jar',
    'cdk-dict-2.9.jar',
    'ambit2-structure2name-3.0.0.jar'
  ];

  async function ensureInit(){
    if(inited) return; inited=true;
    cjState.textContent='loading…';
    setStatus('Loading CheerpJ…');
    await cheerpjInit();

    // load jars sequentially
    for (const f of JARS){
      const url=libURL(f);
      const head=await fetch(url+'?cb='+Date.now(),{method:'HEAD',cache:'no-store'});
      if(!head.ok) throw new Error(`Missing ${f} (HTTP ${head.status})`);
      cj=await cheerpjRunLibrary(url);
    }

    // verify classes
    try{
      await (await cj).org.openscience.cdk.DefaultChemObjectBuilder;
      await (await cj).org.openscience.cdk.smiles.SmilesParser;
      await (await cj).ambit2.structure2name.IUPACNameGenerator;
    }catch(e){ throw new Error('Required classes not exposed: '+S(e)); }

    cjState.textContent='ready';
    setStatus('Runtime ready. Paste a SMILES and click Generate.','ok');
  }

  async function nameFromSmiles(smiles){
    await ensureInit();
    const DefaultChemObjectBuilder=await cj.org.openscience.cdk.DefaultChemObjectBuilder;
    const SmilesParser=await cj.org.openscience.cdk.smiles.SmilesParser;
    const AtomContainerManipulator=await cj.org.openscience.cdk.tools.manipulator.AtomContainerManipulator;
    const IUPAC=await cj.ambit2.structure2name.IUPACNameGenerator;

    const builder=await DefaultChemObjectBuilder.getInstance();
    const sp=new SmilesParser(builder);
    const mol=await sp.parseSmiles(smiles);
    await AtomContainerManipulator.percieveAtomTypesAndConfigureAtoms(mol);

    // Ambit API has static + instance; try gracefully
    if(typeof IUPAC.getInstance==='function'){
      const gen=await IUPAC.getInstance();
      return String(await gen.generate(mol));
    }else if(typeof IUPAC.generate==='function'){
      return String(await IUPAC.generate(mol));
    }else{
      const gen=new IUPAC();
      return String(await gen.generate(mol));
    }
  }

  document.getElementById('run').addEventListener('click', async()=>{
    outEl.textContent='';
    const smiles=(smilesEl.value||'').trim();
    if(!smiles){ setStatus('Enter SMILES'); return; }
    setStatus('Generating…');
    try{
      const name=await nameFromSmiles(smiles);
      log('IUPAC: '+name); setStatus('Done.','ok');
    }catch(e){
      console.error(e); log('Error: '+S(e),'err'); setStatus('Failed','err');
    }
  });

  document.getElementById('copy').addEventListener('click', async()=>{
    try{ await navigator.clipboard.writeText(outEl.textContent.trim()); setStatus('Copied.','ok'); }
    catch(e){ setStatus('Copy failed: '+S(e),'warn'); }
  });

  document.getElementById('clear').addEventListener('click',()=>{
    smilesEl.value=''; outEl.textContent=''; setStatus('Cleared.');
  });
</script>
</body>
</html>
