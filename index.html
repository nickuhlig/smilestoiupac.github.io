<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SMILES → IUPAC (CDK in browser)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#0b1020; color:#e9eefc; }
    .wrap { max-width: 800px; margin: 40px auto; padding: 0 16px; }
    .card { background:#121831; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 12px; font-size:24px; }
    textarea { width:100%; min-height:120px; background:#0c1328; color:#e9eefc; border:1px solid #1e2a55; border-radius:10px; padding:12px; }
    .row { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #2a3a78; background:#1a2650; color:#e9eefc; cursor:pointer; }
    button.primary { background:linear-gradient(135deg,#427bff,#6aa3ff); border:none; }
    .status { margin-top:10px; font-size:13px; color:#9fb0d6; }
    .out { white-space:pre-wrap; background:#0c1328; border:1px solid #1e2a55; border-radius:10px; padding:12px; margin-top:12px; min-height:48px; }
    .badge { font-size:12px; color:#9fb0d6; margin-left:8px; }
    .err { color:#ff6a6a }
  </style>
  <!-- CheerpJ v4 loader -->
  <script src="https://cjrtnc.leaningtech.com/4.2/loader.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>SMILES → IUPAC (algorithmic, offline)</h1>
      <p style="margin:0 0 12px;color:#9fb0d6">Runs CDK entirely in your browser via CheerpJ. No server.</p>

      <label for="smiles" style="font-size:12px;color:#9fb0d6">Isomeric SMILES</label>
      <textarea id="smiles" placeholder="Paste an isomeric SMILES string…">CC(=O)OC1=CC=CC=C1C(=O)O</textarea>

      <div class="row">
        <button id="run" class="primary">Generate IUPAC</button>
        <button id="copy">Copy output</button>
        <button id="clear">Clear</button>
        <span class="badge">Runtime: <span id="cjState">not loaded</span></span>
      </div>

      <div id="status" class="status">Waiting for input…</div>
      <div id="output" class="out"></div>
    </div>
  </div>

  <script>
    // Elements
    const smilesEl = document.getElementById('smiles');
    const outEl    = document.getElementById('output');
    const statusEl = document.getElementById('status');
    const cjState  = document.getElementById('cjState');

    // CheerpJ + CDK handles
    let cj = null;
    let inited = false;

    function setStatus(msg, cls){ statusEl.textContent = msg; statusEl.className = 'status' + (cls ? ' ' + cls : ''); }
    function log(msg, cls){ const d=document.createElement('div'); d.textContent = msg; if(cls) d.className=cls; outEl.appendChild(d); }

    // Prefer Maven Central (CORS-enabled), then fall back to repo path
    const MAVEN_JAR = "https://repo1.maven.org/maven2/org/openscience/cdk/cdk-bundle/2.9/cdk-bundle-2.9.jar";
    function LOCAL_JAR(){ return new URL('lib/cdk-bundle-2.9.jar', window.location.href).toString(); }

    async function fetchOk(url){
      const u = url + (url.includes('?') ? '&' : '?') + 'cb=' + Date.now();
      const r = await fetch(u, { method:'HEAD', cache:'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      return url; // return the clean URL
    }

    async function resolveJarUrl(){
      try { return await fetchOk(MAVEN_JAR); }
      catch(e1){ console.warn('Maven Central fetch failed:', e1.message); }
      try { return await fetchOk(LOCAL_JAR()); }
      catch(e2){
        throw new Error('Could not fetch CDK jar from Maven Central or local repo.\n' +
                        'Last errors:\n- ' + e2.message + '\n' +
                        'Tip: If you added the JAR with Git LFS, GitHub Pages will not serve it. Remove LFS and store it as a normal file, or rely on Maven Central.');
      }
    }

    async function ensureInit() {
      if (inited) return;
      inited = true;

      cjState.textContent = 'loading…';
      setStatus('Loading CheerpJ runtime…');
      await cheerpjInit();

      setStatus('Resolving CDK jar…');
      const jarUrl = await resolveJarUrl();

      setStatus('Loading CDK (first time may take a while)…');
      cj = await cheerpjRunLibrary(jarUrl);

      // Verify by touching classes (CheerpJ v4 pattern)
      await cj.org.openscience.cdk.iupac.IUPACNameGenerator;
      await cj.org.openscience.cdk.smiles.SmilesParser;

      cjState.textContent = 'ready';
      setStatus('Runtime ready. Paste a SMILES and click Generate.');
    }

    async function nameFromSmiles(smiles) {
      await ensureInit();

      const DefaultChemObjectBuilder = await cj.org.openscience.cdk.DefaultChemObjectBuilder;
      const SmilesParser             = await cj.org.openscience.cdk.smiles.SmilesParser;
      const IUPACNameGenerator       = await cj.org.openscience.cdk.iupac.IUPACNameGenerator;
      const AtomContainerManipulator = await cj.org.openscience.cdk.tools.manipulator.AtomContainerManipulator;

      const builder = await DefaultChemObjectBuilder.getInstance();
      const sp = await new SmilesParser(builder);

      const mol = await sp.parseSmiles(smiles);
      await AtomContainerManipulator.percieveAtomTypesAndConfigureAtoms(mol);
      const name = await IUPACNameGenerator.generate(mol);

      return name ? String(name) : "<none>";
    }

    // UI events
    document.getElementById('run').addEventListener('click', async () => {
      outEl.textContent = '';
      const smiles = (smilesEl.value || '').trim();
      if (!smiles) { setStatus('Enter an isomeric SMILES.'); return; }
      setStatus('Generating…');
      try {
        const name = await nameFromSmiles(smiles);
        log('IUPAC (CDK): ' + name);
        setStatus('Done.');
      } catch (e) {
        console.error(e);
        log('Error: ' + e, 'err');
        setStatus('Failed. See error above.', 'err');
      }
    });

    document.getElementById('copy').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(outEl.textContent.trim()); setStatus('Copied.'); }
      catch { setStatus('Copy failed.'); }
    });

    document.getElementById('clear').addEventListener('click', () => {
      smilesEl.value = ''; outEl.textContent = ''; setStatus('Cleared.');
    });
  </script>
</body>
</html>
