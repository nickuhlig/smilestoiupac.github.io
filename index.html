<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SMILES → IUPAC (CDK, in your browser)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Generate algorithmic IUPAC names from SMILES using CDK in the browser via CheerpJ. No server.">
  <style>
    :root { --bg: #0b1020; --card:#121831; --text:#e9eefc; --muted:#9fb0d6; --accent:#6aa3ff; --ok:#36cfc9; --err:#ff6a6a; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 0 16px; }
    .card { background:var(--card); border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); padding: 20px; }
    h1 { font-size: clamp(20px, 2.5vw, 28px); margin: 0 0 8px; }
    p.tag { color: var(--muted); margin: 0 0 16px; }
    textarea, input[type=text] { width:100%; padding:12px 14px; background:#0c1328; color:var(--text); border:1px solid #1e2a55; border-radius:10px; outline:none; }
    textarea { min-height:120px; resize:vertical; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn { padding:10px 14px; background:#1a2650; color:var(--text); border:1px solid #2a3a78; border-radius:10px; cursor:pointer; }
    .btn:hover { background:#213062; }
    .btn.primary { background:linear-gradient(135deg, #427bff, #6aa3ff); border:none; }
    .btn.ghost { background:transparent; border:1px dashed #30407e; }
    .status { margin-top: 12px; font-size: 13px; color: var(--muted); }
    .out { white-space: pre-wrap; background:#0c1328; border:1px solid #1e2a55; border-radius:10px; padding:12px; margin-top:12px; min-height:48px; }
    .small { font-size: 12px; color: var(--muted); }
    .warn { color: #ffd166; }
    .ok { color: var(--ok); }
    .err { color: var(--err); }
    .footer { margin-top: 18px; color: var(--muted); font-size: 12px; }
    .badge { padding: 3px 8px; border-radius: 999px; background: #0c1328; border:1px solid #2a3a78; margin-left:8px; font-size:11px;}
    .kbd { padding:2px 6px; border-radius:6px; background:#0c1328; border:1px solid #2a3a78; }
    .progress { position: relative; height: 10px; background: #1e2a55; border-radius: 999px; overflow: hidden; margin-top: 8px; }
    .progress.hidden { display:none; }
    .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg,#427bff,#6aa3ff); transition: width 200ms ease; }
  </style>
  <!-- CheerpJ v3 runtime (CDN) -->
  <script src="https://cjrtnc.leaningtech.com/3.0rc2/cj3loader.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>SMILES → IUPAC (algorithmic, offline)</h1>
      <p class="tag">Runs <strong>CDK</strong> entirely in your browser via <strong>CheerpJ</strong>. No server calls.</p>
      <p class="small">Tip: works best with <em>isomeric SMILES</em>. Extremely complex fused/bridged systems may yield partial names — that’s a CDK limitation, not the page.</p>
      <label for="smiles" class="small">Isomeric SMILES</label>
      <textarea id="smiles" placeholder="Paste an isomeric SMILES string here..."></textarea>
      <div class="row" style="margin-top:10px;">
        <button id="run" class="btn primary">Generate IUPAC</button>
        <button id="copy" class="btn">Copy output</button>
        <button id="clear" class="btn ghost">Clear</button>
        <span id="cjStatus" class="badge">Runtime: <span id="cjState">not loaded</span></span>
      </div>
      <div id="status" class="status">Waiting for input…</div>
      <div id="progressWrap" class="progress hidden" aria-hidden="true">
      <div id="progressBar" class="progress-bar" role="progressbar"
       aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
      </div>
      <div id="output" class="out"></div>
      <div class="footer">
        <span>CDK IUPACNameGenerator • CheerpJ 3</span>
        <span class="badge">No server</span>
        <span class="badge">Static page</span>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3 style="margin-top:0;">Setup (first time only)</h3>
      <p class="small">For GitHub Pages, add <code class="kbd">/lib/cdk-bundle-2.9.jar</code> to your repo (from Maven Central). The page will load ~10–20&nbsp;MB of Java classes on first use.</p>
      <ol class="small">
        <li>Download <code>cdk-bundle-2.9.jar</code> from Maven Central and place it at <code>/lib/cdk-bundle-2.9.jar</code> in your repo.</li>
        <li>Enable GitHub Pages (Settings → Pages → Deploy from branch).</li>
        <li>Open your site. First load can take ~10–30s depending on network; subsequent loads are cached by the browser.</li>
      </ol>
      <p class="warn small">Note: In-browser IUPAC generation is experimental; for guaranteed PIN-grade names, use commercial namers.</p>
    </div>
  </div>
<!-- CheerpJ v4 loader (must come before your script) -->
<script src="https://cjrtnc.leaningtech.com/4.2/loader.js"></script>

<script>
  const smilesEl = document.getElementById('smiles');
  const outEl = document.getElementById('output');
  const statusEl = document.getElementById('status');
  const cjState = document.getElementById('cjState');
  const progressWrap = document.getElementById('progressWrap');
  const progressBar  = document.getElementById('progressBar');

  let cj = null;
  let cdkReadyPromise = null;

  // ---- tiny progress helpers ----
  function showProgress(){ progressWrap?.classList.remove('hidden'); }
  function hideProgress(){ progressWrap?.classList.add('hidden'); setProgress(0); }
  function setProgress(p, label){
    if (progressBar){ progressBar.style.width = (p|0) + '%'; progressBar.setAttribute('aria-valuenow', String(p|0)); }
    if (label) setStatus(label);
  }
  function setStatus(msg, cls){ statusEl.textContent = msg; statusEl.className = 'status' + (cls ? ' ' + cls : ''); }
  function log(msg, cls){ const d=document.createElement('div'); d.textContent = msg; if(cls) d.className=cls; outEl.appendChild(d); }

  // ---- helper: pick the correct JAR URL on GitHub Pages ----
  function guessJarPath(){
    // If your site URL is https://USER.github.io/REPO/, the file lives at /REPO/lib/cdk-bundle-2.9.jar
    // CheerpJ maps "/app" to the site root at runtime.
    // We'll try the most reliable two options in order.
    return [
      "/app/lib/cdk-bundle-2.9.jar",        // preferred for CheerpJ
      "lib/cdk-bundle-2.9.jar",              // fallback (relative)
    ];
  }

  async function initCheerpJAndCDK() {
    if (cdkReadyPromise) return cdkReadyPromise;
    cdkReadyPromise = (async () => {
      cjState.textContent = 'loading…';
      showProgress(); setProgress(5, 'Loading CheerpJ runtime…');
      await cheerpjInit();
      setProgress(20, 'Loading CDK…');

      // Try candidate paths until one works
      let lastErr; let ok = false;
      for (const cand of guessJarPath()){
        try {
          // IMPORTANT: capture the handle; cheerpjRunLibrary returns a CJ3Library
          cj = await cheerpjRunLibrary(cand);
          // Prove classes are mapped: force load a known class
          await cj.java.lang.Class.forName("org.openscience.cdk.iupac.IUPACNameGenerator");
          ok = true;
          break;
        } catch(e){
          lastErr = e;
          console.warn("CDK load failed for", cand, e);
        }
      }
      if (!ok) {
        setProgress(100, 'Failed to load CDK.');
        cjState.textContent = 'error';
        throw new Error("Could not load CDK JAR. Check that lib/cdk-bundle-2.9.jar exists in the repo. Last error: " + lastErr);
      }

      setProgress(90, 'Finalizing…');
      cjState.textContent = 'ready';
      setProgress(100, 'Runtime ready. Paste a SMILES and click Generate.');
      setTimeout(hideProgress, 600);
    })().catch(err => {
      setStatus(String(err), 'err');
      throw err;
    });
    return cdkReadyPromise;
  }

  async function generateName(smiles) {
    await initCheerpJAndCDK();

    // Pull classes via the cj handle
    const DefaultChemObjectBuilder   = await cj.org.openscience.cdk.DefaultChemObjectBuilder;
    const SmilesParser               = await cj.org.openscience.cdk.smiles.SmilesParser;
    const IUPACNameGenerator         = await cj.org.openscience.cdk.iupac.IUPACNameGenerator;
    const AtomContainerManipulator   = await cj.org.openscience.cdk.tools.manipulator.AtomContainerManipulator;

    const builder = await DefaultChemObjectBuilder.getInstance();
    const sp = await new SmilesParser(builder);

    try {
      showProgress(); setProgress(10, 'Parsing SMILES…');
      const mol = await sp.parseSmiles(smiles);

      setProgress(45, 'Configuring atoms…');
      await AtomContainerManipulator.percieveAtomTypesAndConfigureAtoms(mol);

      setProgress(70, 'Generating IUPAC…');
      const name = await IUPACNameGenerator.generate(mol);

      setProgress(100, 'Done.'); setTimeout(hideProgress, 500);
      return name ? String(name) : "<none>";
    } catch (e) {
      hideProgress();
      // Surface full error for debugging
      console.error("Naming error:", e);
      throw new Error("Naming failed: " + (e && e.message ? e.message : String(e)));
    }
  }

  // ---- UI ----
  document.getElementById('run').addEventListener('click', async () => {
    outEl.textContent = '';
    const smiles = smilesEl.value.trim();
    if (!smiles) { setStatus('Enter an isomeric SMILES.', 'warn'); return; }
    setStatus('Generating…');
    try {
      const name = await generateName(smiles);
      log('IUPAC (CDK): ' + name);
      setStatus('Done.', 'ok');
    } catch (e) {
      log('Error: ' + e, 'err');
      setStatus('Failed. See error above.', 'err');
    }
  });

  document.getElementById('copy').addEventListener('click', async () => {
    const text = outEl.textContent.trim();
    try { await navigator.clipboard.writeText(text); setStatus('Copied to clipboard.', 'ok'); }
    catch { setStatus('Copy failed. Select and copy manually.', 'warn'); }
  });

  document.getElementById('clear').addEventListener('click', () => {
    smilesEl.value = ''; outEl.textContent = ''; setStatus('Cleared.');
  });

  // Preload runtime in background
  initCheerpJAndCDK();
</script>


</body>
</html>
