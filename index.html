<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SMILES → IUPAC (CDK + Ambit, single-JAR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#0b1020; color:#e9eefc; }
    .wrap { max-width: 860px; margin: 40px auto; padding: 0 16px; }
    .card { background:#121831; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 12px; font-size:24px; }
    textarea { width:100%; min-height:120px; background:#0c1328; color:#e9eefc; border:1px solid #1e2a55; border-radius:10px; padding:12px; }
    .row { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; align-items:center; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #2a3a78; background:#1a2650; color:#e9eefc; cursor:pointer; }
    button.primary { background:linear-gradient(135deg,#427bff,#6aa3ff); border:none; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .status { margin-top:10px; font-size:13px; color:#9fb0d6; }
    .out { white-space:pre-wrap; background:#0c1328; border:1px solid #1e2a55; border-radius:10px; padding:12px; margin-top:12px; min-height:48px; }
    .badge { font-size:12px; color:#9fb0d6; margin-left:8px; }
    .progress { position: relative; height: 10px; background: #1e2a55; border-radius: 999px; overflow: hidden; margin-top: 8px; }
    .progress.hidden { display:none; }
    .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg,#427bff,#6aa3ff); transition: width 180ms ease; }
    .err { color:#ff6a6a } .ok { color:#36cfc9 } .warn { color:#ffd166 }
  </style>
  <!-- CheerpJ v4 loader -->
  <script src="https://cjrtnc.leaningtech.com/4.2/loader.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>SMILES → IUPAC (single-JAR, offline)</h1>
      <p style="margin:0 0 12px;color:#9fb0d6">CDK (SMILES parsing) + Ambit (namer) combined into one JAR, run via CheerpJ in your browser.</p>

      <label for="smiles" style="font-size:12px;color:#9fb0d6">Isomeric SMILES</label>
      <textarea id="smiles">CC(=O)OC1=CC=CC=C1C(=O)O</textarea>

      <div class="row">
        <button id="run"  class="primary">Generate IUPAC</button>
        <button id="copy">Copy</button>
        <button id="clear">Clear</button>
        <span class="badge">Runtime: <span id="cjState">not loaded</span></span>
      </div>

      <div id="status" class="status">Waiting…</div>

      <div id="progressWrap" class="progress hidden" aria-hidden="true">
        <div id="progressBar" class="progress-bar" role="progressbar"
             aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
      </div>

      <div id="output" class="out"></div>
    </div>
  </div>

<script>
  // ----- safe string -----
  function S(x){ try{
    if(x==null) return String(x);
    if(typeof x==='string') return x;
    if(x instanceof Error) return x.message||x.toString();
    const t=x.toString?.(); if(t && t!=='[object Object]') return t;
    return JSON.stringify(x);
  }catch{ return '<unprintable>'; } }

  // ----- helper to catch missed awaits -----
  function assertNotThenable(x, label){
    if (x && typeof x.then === 'function') {
      throw new Error(`Missing await on ${label}`);
    }
  }

  // ----- tiny checkpoint logger -----
  function checkpoint(label){ console.log('[CHK]', label); }

  // ----- UI -----
  const smilesEl=document.getElementById('smiles');
  const outEl   =document.getElementById('output');
  const statusEl=document.getElementById('status');
  const cjState =document.getElementById('cjState');
  const btnRun  =document.getElementById('run');
  const btnCopy =document.getElementById('copy');
  const btnClear=document.getElementById('clear');

  const progressWrap=document.getElementById('progressWrap');
  const progressBar =document.getElementById('progressBar');

  function setStatus(msg,cls){ statusEl.textContent=S(msg); statusEl.className='status'+(cls?' '+cls:''); }
  function log(msg,cls){ const d=document.createElement('div'); d.textContent=S(msg); if(cls) d.className=cls; outEl.appendChild(d); }
  function showProgress(){ progressWrap.classList.remove('hidden'); progressWrap.setAttribute('aria-hidden','false'); }
  function hideProgress(){ progressWrap.classList.add('hidden'); progressWrap.setAttribute('aria-hidden','true'); setProgress(0); }
  function setProgress(p,label){ const v=Math.max(0,Math.min(100,p|0)); progressBar.style.width=v+'%'; progressBar.setAttribute('aria-valuenow',String(v)); if(label) setStatus(label); }
  function disableButtons(dis){ btnRun.disabled=dis; btnCopy.disabled=dis; btnClear.disabled=dis; }

  // ----- CheerpJ single-bundle load -----
  let cj=null, initPromise=null;

  function bundleURL(){
    const parts = window.location.pathname.split('/').filter(Boolean);
    const base  = parts.length ? ('/' + parts[0] + '/') : '/';
    return new URL('lib/iupac-mini-bundle.jar', new URL(base, window.location.origin)).toString();
  }

  async function ensureInit(){
    if (initPromise) return initPromise;
    initPromise = (async () => {
      disableButtons(true);
      cjState.textContent='loading…';
      showProgress(); setProgress(5,'Loading CheerpJ runtime…');
      await cheerpjInit();

      const url = bundleURL();
      setProgress(20,'Checking bundle…');
      const head = await fetch(url + '?cb=' + Date.now(), { method:'HEAD', cache:'no-store' });
      if (!head.ok) { hideProgress(); disableButtons(false); throw new Error('Missing iupac-mini-bundle.jar (HTTP '+head.status+') at '+url); }

      setProgress(40,'Loading single JAR…');
      cj = await cheerpjRunLibrary(url);

      // Verify key classes are exposed
      setProgress(85,'Finalizing…');
      checkpoint('await CDK + Ambit class proxies');
      await cj.org.openscience.cdk.DefaultChemObjectBuilder;
      await cj.org.openscience.cdk.smiles.SmilesParser;
      await cj.org.openscience.cdk.tools.manipulator.AtomContainerManipulator;
      await cj.ambit2.structure2name.IUPACNameGenerator;

      cjState.textContent='ready';
      setProgress(100,'Runtime ready. Paste a SMILES and click Generate.');
      setTimeout(hideProgress, 600);
      disableButtons(false);
    })().catch(err => {
      setStatus('Init failed: ' + S(err), 'err');
      console.error(err);
      disableButtons(false);
      throw err;
    });
    return initPromise;
  }

  async function nameFromSmiles(smiles){
    await ensureInit();
    try {
      checkpoint('get class proxies');
      const DefaultChemObjectBuilder = await cj.org.openscience.cdk.DefaultChemObjectBuilder;
      assertNotThenable(DefaultChemObjectBuilder, 'DefaultChemObjectBuilder class');

      const SmilesParser             = await cj.org.openscience.cdk.smiles.SmilesParser;
      assertNotThenable(SmilesParser, 'SmilesParser class');

      const AtomContainerManipulator = await cj.org.openscience.cdk.tools.manipulator.AtomContainerManipulator;
      assertNotThenable(AtomContainerManipulator, 'AtomContainerManipulator class');

      const IUPAC                    = await cj.ambit2.structure2name.IUPACNameGenerator;
      assertNotThenable(IUPAC, 'IUPACNameGenerator class');

      checkpoint('builder.getInstance');
      const builder = await DefaultChemObjectBuilder.getInstance();
      assertNotThenable(builder, 'DefaultChemObjectBuilder.getInstance()');

      checkpoint('new SmilesParser');
      const sp = await new SmilesParser(builder); // constructor is async
      assertNotThenable(sp, 'new SmilesParser(builder)');

      checkpoint('parseSmiles');
      const mol = await sp.parseSmiles(smiles);
      assertNotThenable(mol, 'sp.parseSmiles(smiles) result');

      checkpoint('configure atoms');
      await AtomContainerManipulator.percieveAtomTypesAndConfigureAtoms(mol);

      // Ambit API variants — try in order
      checkpoint('IUPAC naming');
      if (typeof IUPAC.getInstance === 'function') {
        const gen = await IUPAC.getInstance();
        assertNotThenable(gen, 'IUPAC.getInstance()');

        const name = await gen.generate(mol);
        assertNotThenable(name, 'gen.generate(mol)');
        return name ? String(name) : "<none>";
      }

      if (typeof IUPAC.generate === 'function') {
        const name = await IUPAC.generate(mol);
        assertNotThenable(name, 'IUPAC.generate(mol)');
        return name ? String(name) : "<none>";
      }

      // Other Ambit variants seen in the wild:
      const maybeGet = IUPAC.getIUPACName || IUPAC.getPreferredIUPACName;
      if (typeof maybeGet === 'function') {
        const name = await maybeGet.call(IUPAC, mol);
        assertNotThenable(name, 'IUPAC.get*IUPACName(mol)');
        return name ? String(name) : "<none>";
      }

      const gen = await new IUPAC(); // last-resort instance constructor
      assertNotThenable(gen, 'new IUPAC()');
      const name = await gen.generate ? gen.generate(mol)
                 : gen.getIUPACName ? gen.getIUPACName(mol)
                 : gen.getPreferredIUPACName ? gen.getPreferredIUPACName(mol)
                 : null;
      assertNotThenable(name, 'IUPAC instance naming');
      if (name == null) throw new Error('IUPACNameGenerator has no supported method (generate/getIUPACName/getPreferredIUPACName).');
      return String(name);

    } catch (e){
      console.error('nameFromSmiles failed:', e);
      throw e;
    }
  }

  // ----- UI events -----
  btnRun.addEventListener('click', async () => {
    outEl.textContent='';
    const smiles=(smilesEl.value||'').trim();
    if(!smiles){ setStatus('Enter an isomeric SMILES.'); return; }
    disableButtons(true);
    setStatus('Generating…');
    try {
      const name = await nameFromSmiles(smiles);
      log('IUPAC: ' + name);
      setStatus('Done.','ok');
    } catch (e) {
      log('Error: ' + S(e), 'err');
      setStatus('Failed. See error above.','err');
    } finally {
      disableButtons(false);
    }
  });

  btnCopy.addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(outEl.textContent.trim()); setStatus('Copied.','ok'); }
    catch (e) { setStatus('Copy failed: ' + S(e), 'warn'); }
  });

  btnClear.addEventListener('click', () => {
    smilesEl.value=''; outEl.textContent=''; setStatus('Cleared.');
  });
</script>
</body>
</html>
